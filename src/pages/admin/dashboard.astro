---
import Layout from '../../layouts/Layout.astro';
import { getAllPillars } from '../../db/lib';

const pillars = await getAllPillars();
---
<Layout title="Admin Dashboard">
    <div class="container mx-auto p-4">
        <div class="flex justify-between items-center mb-8">
            <h1 class="text-4xl font-bold">Admin Dashboard</h1>
            <a href="/admin/new" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Create New Pillar
            </a>
        </div>

        <table class="min-w-full bg-white">
            <thead>
                <tr>
                    <th class="py-2 px-4 border-b">Title</th>
                    <th class="py-2 px-4 border-b">Actions</th>
                </tr>
            </thead>
            <tbody>
                {pillars.map(pillar => (
                    <tr data-id={pillar.id}>
                        <td class="py-2 px-4 border-b">{pillar.title}</td>
                        <td class="py-2 px-4 border-b">
                            <a href={`/admin/edit/${pillar.id}`} class="text-blue-500 hover:underline mr-4">Edit</a>
                            <button class="text-red-500 hover:underline delete-button">Delete</button>
                        </td>
                    </tr>
                ))}
            </tbody>
        </table>
    </div>
    <script>
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', async (e) => {
                const row = (e.target as HTMLElement).closest('tr');
                const id = row.dataset.id;
                if (confirm('Are you sure you want to delete this pillar?')) {
                    const response = await fetch(`/api/posts/${id}`, {
                        method: 'DELETE'
                    });
                    if (response.ok) {
                        row.remove();
                    } else {
                        alert('Failed to delete pillar.');
                    }
                }
            });
        });
    </script>
</Layout>
